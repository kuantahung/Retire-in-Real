<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retire in REAL - 退休規劃 (V6.1)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0f2c4e;
            --accent-color: #c5a065;
            --text-color: #333333;
            --light-bg: #f4f6f9;
        }

        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; color: var(--text-color); }
        h1, h2, h3, h4, h5 { font-family: 'Noto Serif TC', serif; }
        
        /* === 螢幕顯示樣式 === */
        .web-header { 
            background: linear-gradient(135deg, var(--primary-color), #2a5298); 
            color: white; 
            padding: 25px 20px; 
            border-radius: 0 0 20px 20px; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .web-view-card { 
            border: none; 
            border-radius: 16px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
            background: white; 
            margin-bottom: 20px; 
            padding: 20px;
        }

        .form-floating > .form-control { height: 60px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .form-floating > .form-select { height: 60px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .form-floating > label { padding-top: 0.8rem; font-size: 0.9rem; color: #888; }
        .form-control:focus { box-shadow: 0 0 0 3px rgba(15, 44, 78, 0.1); border-color: var(--primary-color); }
        
        .section-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }
        .section-label i { margin-right: 8px; color: var(--accent-color); }

        .ref-badge { 
            font-size: 0.75rem; 
            color: #666; 
            background-color: #fff3cd; 
            padding: 4px 10px; 
            border-radius: 20px; 
            border: 1px solid #ffecb5; 
            margin-top: 5px; 
            display: inline-block; 
        }

        /* 輸入介面的紅色註解 (強制顯示) */
        .input-note {
            display: block !important; /* 強制顯示 */
            font-size: 0.75rem;
            color: #dc3545;
            font-weight: bold;
            margin-top: 5px;
            padding-left: 2px;
            line-height: 1.3;
            position: relative;
            z-index: 10;
        }
        
        .bottom-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 15px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .container { padding-bottom: 80px; }
        #print-report-container { display: none; }

        /* === 列印專用樣式 === */
        @media print {
            @page { size: A4 landscape; margin: 0; }
            
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                margin: 0;
                padding: 0;
                width: 297mm;
                height: 210mm;
                overflow: hidden;
            }
            
            .web-interface, .no-print, .btn, .bottom-action-bar { display: none !important; }
            .container { padding-bottom: 0; }
            
            #print-report-container { 
                display: flex;
                flex-direction: column;
                width: 100%; 
                height: 100%; 
                box-sizing: border-box; 
                padding: 10mm 12mm;
                background: white;
            }

            .report-header { 
                flex: 0 0 auto;
                display: flex; 
                justify-content: space-between; 
                align-items: center;
                border-bottom: 2px solid var(--accent-color); 
                padding-bottom: 8px; 
                margin-bottom: 12px; 
            }
            .report-title { color: var(--primary-color); font-size: 24pt; font-weight: 900; margin: 0; letter-spacing: -1px; line-height: 1; }
            .report-subtitle { color: #666; font-size: 9pt; letter-spacing: 2px; text-transform: uppercase; margin-top: 4px; }
            .client-badge { 
                background-color: var(--light-bg); 
                padding: 6px 15px; 
                border-radius: 6px; 
                text-align: right; 
                border-left: 5px solid var(--primary-color);
            }
            .client-name { font-size: 14pt; font-weight: bold; color: var(--primary-color); line-height: 1.2; }
            .report-meta { font-size: 9pt; color: #888; margin-top: 2px; }

            .report-content-wrapper {
                flex: 1 1 auto;
                display: grid;
                grid-template-columns: 25% 45% 26%;
                gap: 15px;
                overflow: hidden;
            }

            .rpt-col { 
                display: flex; 
                flex-direction: column; 
                justify-content: flex-start;
                gap: 15px; 
                height: 100%;
            }

            .rpt-card { 
                border: 1px solid #e0e0e0; 
                border-radius: 8px; 
                padding: 12px; 
                background-color: #fff;
                display: flex;
                flex-direction: column;
            }
            .rpt-col.middle .rpt-card { flex: 1; }

            .rpt-card-header {
                font-family: 'Noto Serif TC', serif;
                color: var(--primary-color);
                font-size: 11pt;
                font-weight: bold;
                border-bottom: 2px solid #f0f0f0;
                padding-bottom: 6px;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                flex: 0 0 auto;
            }
            .rpt-card-header i { margin-right: 8px; color: var(--accent-color); }

            .kpi-box { 
                background-color: var(--light-bg); 
                text-align: center; 
                padding: 12px 5px; 
                border-radius: 6px; 
                margin-bottom: 10px;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .kpi-title { font-size: 8pt; color: #666; text-transform: uppercase; }
            .kpi-num { font-size: 20pt; font-weight: 900; color: var(--primary-color); line-height: 1.2; margin: 2px 0; }
            .kpi-desc { font-size: 8pt; color: #888; }

            .fin-table { width: 100%; font-size: 10pt; border-collapse: collapse; height: 100%; }
            .fin-table td { 
                padding: 6px 8px;
                border-bottom: 1px dashed #e0e0e0; 
                vertical-align: middle;
            }
            .fin-table tr:last-child td { border-bottom: none; }
            .fin-label { color: #444; }
            .fin-val { text-align: right; font-family: 'Consolas', monospace; font-weight: 600; font-size: 11pt; color: #000; }
            .fin-total { 
                background-color: #f8f9fa; 
                font-weight: bold; 
                color: var(--primary-color);
                border-top: 2px solid var(--primary-color);
            }
            .fin-total td { padding: 10px 8px; font-size: 11pt; }
            
            .gap-box {
                background: linear-gradient(135deg, #fffcf5 0%, #fff 100%);
                border: 1px solid var(--accent-color);
                text-align: center;
                padding: 15px 10px;
                border-radius: 8px;
                margin-bottom: 10px;
                flex: 0 0 auto;
            }
            .gap-label { font-size: 10pt; color: #666; margin-bottom: 5px; }
            .gap-number { font-size: 32pt; font-weight: 900; color: #dc3545; font-family: 'Noto Serif TC', serif; margin: 0; line-height: 1.1; }
            .gap-msg { font-size: 9pt; font-weight: bold; color: #555; margin-top: 5px; }
            
            .delay-card {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            .delay-table { width: 100%; font-size: 9pt; margin-top: auto; margin-bottom: auto; }
            .delay-table th { background: #f0f0f0; padding: 6px 2px; font-size: 8.5pt; text-align: center; color: #555; }
            .delay-table td { border-bottom: 1px solid #eee; padding: 8px 2px; text-align: center; }
            .inc-text { color: #dc3545; font-weight: bold; }

            .report-footer {
                flex: 0 0 auto;
                border-top: 1px solid #ddd;
                padding-top: 6px;
                margin-top: 10px;
                font-size: 8pt;
                color: #999;
                display: flex;
                justify-content: flex-end; 
            }
        }
    </style>
</head>
<body>

<div class="web-header text-center web-interface">
    <h3 class="fw-bold mb-1"><i class="bi bi-calculator"></i> Retire in REAL</h3>
    <p class="mb-0 small opacity-75">退休規劃 v6.1</p>
</div>

<div class="container web-interface">
    <form id="calcForm" autocomplete="off">
        
        <div class="web-view-card">
            <div class="section-label"><i class="bi bi-person-vcard"></i> 基本資料</div>
            <div class="row g-2">
                <div class="col-7">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="userName" placeholder="姓名" autocomplete="off">
                        <label for="userName">姓名</label>
                    </div>
                </div>
                <div class="col-5">
                    <div class="form-floating">
                        <select class="form-select" id="userGender">
                            <option value="F">女</option>
                            <option value="M">男</option>
                        </select>
                        <label for="userGender">性別</label>
                    </div>
                </div>
                <div class="col-8">
                    <div class="form-floating">
                        <input type="date" class="form-control" id="birthDate" placeholder="生日" autocomplete="off">
                        <label for="birthDate">出生年月日</label>
                    </div>
                </div>
                <div class="col-4">
                    <div class="form-floating">
                        <input type="text" class="form-control bg-light" id="currentAge" placeholder="--" readonly>
                        <label>保險年齡</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="web-view-card">
            <div class="section-label"><i class="bi bi-clock-history"></i> 退休時程設定</div>
            <div class="row g-2">
                <div class="col-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="retireAge" placeholder="60" autocomplete="off">
                        <label>預計退休 (歲)</label>
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="lifeAge" placeholder="85" autocomplete="off">
                        <label>預期壽命 (歲)</label>
                    </div>
                </div>
                
                <div class="col-12 text-end mt-0">
                    <span class="ref-badge"><i class="bi bi-info-circle"></i> 113年平均壽命：男 77.42歲 / 女 84.30歲</span>
                </div>

                <div class="col-12 mt-2">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="inflation" placeholder="2.0" step="0.1" autocomplete="off">
                        <label>預估通膨率 (%)</label>
                    </div>
                    <div class="text-end">
                        <span class="ref-badge"><i class="bi bi-graph-up-arrow"></i> 近30年平均CPI約 1.74%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="web-view-card">
            <div class="section-label"><i class="bi bi-currency-dollar"></i> 財務與開支</div>
            <div class="row g-2">
                <div class="col-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="basicExp" placeholder="30000" autocomplete="off">
                        <label>基本開銷/月</label>
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="funExp" placeholder="10000" autocomplete="off">
                        <label>享樂開銷/月</label>
                    </div>
                </div>
                <div class="col-12">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="currentAssets" placeholder="5000000" autocomplete="off">
                        <label>現有已備資產 (存款/投資)</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="web-view-card">
            <div class="section-label"><i class="bi bi-bank"></i> 勞保年金試算</div>
            <div class="row g-2 align-items-start">
                <div class="col-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="liSalary" placeholder="45800" autocomplete="off">
                        <label>投保薪資</label>
                    </div>
                    <div class="input-note">
                        *退休前最高60個月平均投保薪資
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="liYears" placeholder="30" autocomplete="off">
                        <label>投保年資</label>
                    </div>
                    <div class="input-note" style="visibility: hidden;">.</div>
                </div>
                
                <div class="col-12">
                    <div class="form-floating">
                        <input type="number" class="form-control" id="pensionRate" placeholder="70" autocomplete="off">
                        <label>政策風險打折 (例如輸入70代表領7成)</label>
                    </div>
                </div>
                <div class="col-12 mt-2">
                    <div class="alert alert-light border d-flex justify-content-between align-items-center mb-0 p-2">
                        <span class="small text-muted">試算結果 (擇優)</span>
                        <span class="fw-bold text-success fs-5" id="web_pension_disp">--</span>
                        <input type="hidden" id="govPensionMonthly">
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="bottom-action-bar web-interface">
    <button onclick="resetForm()" class="btn btn-outline-secondary" style="flex:1">
        <i class="bi bi-arrow-counterclockwise"></i> 重填
    </button>
    <button onclick="handlePrint()" class="btn btn-primary fw-bold shadow" style="flex:2">
        <i class="bi bi-file-earmark-pdf-fill"></i> 產出報告
    </button>
</div>

<div id="print-report-container">
    <div class="report-header">
        <div>
            <h1 class="report-title">RETIREMENT ROADMAP</h1>
            <div class="report-subtitle">Personal Financial Planning</div>
        </div>
        <div class="client-badge">
            <div class="client-name"><span id="rpt_name">--</span> <small id="rpt_gender" style="font-size:0.6em; font-weight:normal"></small></div>
            <div class="report-meta">Date: <span id="rpt_date">--</span></div>
        </div>
    </div>
    <div class="report-content-wrapper">
        <div class="rpt-col">
            <div class="rpt-card" style="flex:1">
                <div class="rpt-card-header"><i class="bi bi-person-bounding-box"></i> 規劃參數</div>
                <div class="kpi-box">
                    <div class="kpi-title">距離退休 Years to Retire</div>
                    <div class="kpi-num"><span id="rpt_prepYears">--</span> <small style="font-size:12pt">年</small></div>
                    <div class="kpi-desc">目前 <span id="rpt_age">--</span> 歲 → <span id="rpt_retireAge">--</span> 歲</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-title">退休生活 Duration</div>
                    <div class="kpi-num"><span id="rpt_retireYears">--</span> <small style="font-size:12pt">年</small></div>
                    <div class="kpi-desc">預期至 <span id="rpt_lifeAge">--</span> 歲</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-title">通膨假設 Inflation</div>
                    <div class="kpi-num"><span id="rpt_inflation">--</span>%</div>
                    <div class="kpi-desc">複利效應因子</div>
                </div>
                <div style="font-size:8pt; color:#999; margin-top:10px; padding:0 5px; line-height:1.4;">
                    <i class="bi bi-info-circle"></i> 通膨參考：<br>主計總處近30年平均CPI約 1.74%<br>
                    <i class="bi bi-person"></i> 113年平均壽命：男77.42 / 女84.30
                </div>
            </div>
        </div>
        <div class="rpt-col middle">
            <div class="rpt-card">
                <div class="rpt-card-header"><i class="bi bi-graph-up-arrow"></i> 退休需求 (Needs)</div>
                <table class="fin-table">
                    <tr><td class="fin-label">每月基本生活 (現值)</td><td class="fin-val" id="rpt_basicExp">--</td></tr>
                    <tr><td class="fin-label">每月享樂生活 (現值)</td><td class="fin-val" id="rpt_funExp">--</td></tr>
                    <tr style="background:#fcfcfc"><td class="fin-label" style="font-weight:bold">每月總需求 (現值)</td><td class="fin-val" id="rpt_monthlyTotal" style="font-weight:bold">--</td></tr>
                    <tr><td colspan="2" style="text-align:center; color:#999; font-size:8pt; padding:4px;">↓ 經過 <span id="rpt_prepYears_s">--</span> 年通膨複利 ↓</td></tr>
                    <tr><td class="fin-label">退休首月所需 (未來值)</td><td class="fin-val text-danger" id="rpt_futureMonthly">--</td></tr>
                    <tr class="fin-total"><td>退休總應備金額 (A)</td><td class="fin-val" id="rpt_inflatedTotal">--</td></tr>
                </table>
            </div>
            <div class="rpt-card">
                <div class="rpt-card-header"><i class="bi bi-wallet2"></i> 資產供給 (Supply)</div>
                <table class="fin-table">
                    <tr><td class="fin-label">現有已備資產</td><td class="fin-val" id="rpt_assets">--</td></tr>
                    <tr><td colspan="2" style="padding-top:10px; padding-bottom:4px;">
                        <div style="font-size:9pt; font-weight:bold; color:#0f2c4e;">預估勞保年金 (擇優後)</div>
                        <div style="font-size:7pt; color:#dc3545; font-weight:bold; margin-bottom:2px;">*退休前最高60個月平均投保薪資</div>
                        <div style="display:flex; justify-content:space-between; font-size:9pt; color:#666; border-left:3px solid #ddd; padding-left:10px; background:#fafafa; margin-top:2px;">
                            <span>A式(保證): <span id="rpt_formulaA"></span></span>
                            <span>B式(年資): <span id="rpt_formulaB"></span></span>
                        </div>
                    </td></tr>
                    <tr><td class="fin-label">每月可領 (風險打折 <span id="rpt_riskRate"></span>%)</td><td class="fin-val" id="rpt_realPensionMonthly">--</td></tr>
                    <tr class="fin-total"><td>資產與年金總現值 (B)</td><td class="fin-val" id="rpt_pensionTotal">--</td></tr>
                </table>
            </div>
        </div>
        <div class="rpt-col">
            <div class="rpt-card">
                <div class="rpt-card-header"><i class="bi bi-bullseye"></i> 最終結論 (Conclusion)</div>
                <div class="gap-box">
                    <div class="gap-label">退休準備金缺口 / 盈餘</div>
                    <div class="gap-number" id="rpt_gapAmount">--</div>
                    <div class="gap-msg" id="rpt_gapMsg">計算中...</div>
                </div>
            </div>
            <div class="rpt-card delay-card" id="rpt_delay_section" style="display:none;">
                <div class="rpt-card-header" style="color:#dc3545"><i class="bi bi-alarm"></i> 拖延代價分析</div>
                <div style="font-size:9pt; margin-bottom:5px; text-align:center;">
                    若現在開始，每年需存：<br>
                    <span id="rpt_yearlySave" style="font-size:14pt; font-weight:bold; color:#0f2c4e; border-bottom:2px solid #c5a065">--</span> 元
                </div>
                <table class="delay-table">
                    <thead><tr><th>延後</th><th>年儲蓄額</th><th>增加金額</th><th>增加比例</th></tr></thead>
                    <tbody>
                        <tr><td>1年</td><td id="d_amt_1">--</td><td class="inc-text" id="d_inc_1">--</td><td class="inc-text" id="d_pct_1">--</td></tr>
                        <tr><td>2年</td><td id="d_amt_2">--</td><td class="inc-text" id="d_inc_2">--</td><td class="inc-text" id="d_pct_2">--</td></tr>
                        <tr><td>3年</td><td id="d_amt_3">--</td><td class="inc-text" id="d_inc_3">--</td><td class="inc-text" id="d_pct_3">--</td></tr>
                    </tbody>
                </table>
                <div style="font-size:8pt; color:#888; margin-top:auto; text-align:center;">*時間是投資最大的槓桿</div>
            </div>
        </div>
    </div>
    <div class="report-footer"><div>本報告僅供參考</div></div>
</div>

<script>
    const today = new Date().toLocaleDateString();
    document.getElementById('rpt_date').innerText = today;

    function fmt(num) {
        if (!num && num !== 0) return "--";
        return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function resetForm() {
        if(confirm('確定要清空所有資料重新填寫嗎？')) {
            document.getElementById('calcForm').reset();
            calculate();
        }
    }

    function handlePrint() {
        var ua = navigator.userAgent || navigator.vendor || window.opera;
        var isInApp = (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Line") > -1) || (ua.indexOf("Instagram") > -1);

        if (isInApp) {
            alert("⚠️ 偵測到您正在使用 App 內建瀏覽器（如 Line/FB），可能無法正常下載 PDF。\n\n請點擊右上角選單，選擇「使用預設瀏覽器開啟」或「在 Chrome/Safari 中開啟」，即可正常產出報告！");
        } else {
            window.print();
        }
    }

    function calcAge() {
        const birthStr = document.getElementById('birthDate').value;
        if(!birthStr) return 0;
        const birth = new Date(birthStr);
        const now = new Date();
        let months = (now.getFullYear() - birth.getFullYear()) * 12 + (now.getMonth() - birth.getMonth());
        if(now.getDate() < birth.getDate()) months--;
        let age = Math.floor(months / 12);
        if(months % 12 >= 6) age++;
        document.getElementById('currentAge').value = age;
        return age;
    }

    function calcLabor() {
        const salary = parseFloat(document.getElementById('liSalary').value) || 0;
        const years = parseFloat(document.getElementById('liYears').value) || 0;
        const valA = (years * salary * 0.00775) + 3000;
        const valB = (years * salary * 0.0155);
        const winner = Math.max(valA, valB);
        document.getElementById('govPensionMonthly').value = winner;
        document.getElementById('web_pension_disp').innerText = fmt(winner);
        document.getElementById('rpt_formulaA').innerText = fmt(valA);
        document.getElementById('rpt_formulaB').innerText = fmt(valB);
        return winner;
    }

    function calculate() {
        document.getElementById('rpt_name').innerText = document.getElementById('userName').value || "--";
        document.getElementById('rpt_gender').innerText = document.getElementById('userGender').value === 'F' ? '女士' : '先生';
        
        const age = calcAge();
        const liMonthly = calcLabor();

        const retireAge = parseFloat(document.getElementById('retireAge').value) || 0;
        const lifeAge = parseFloat(document.getElementById('lifeAge').value) || 0;
        const inflation = parseFloat(document.getElementById('inflation').value) || 0;
        const basicExp = parseFloat(document.getElementById('basicExp').value) || 0;
        const funExp = parseFloat(document.getElementById('funExp').value) || 0;
        const assets = parseFloat(document.getElementById('currentAssets').value) || 0;
        const riskRate = parseFloat(document.getElementById('pensionRate').value) || 0;

        let yearsToPrep = 0;
        let yearsInRetire = 0;
        if (retireAge > 0 && age > 0) yearsToPrep = Math.max(0, retireAge - age);
        if (lifeAge > 0 && retireAge > 0) yearsInRetire = Math.max(0, lifeAge - retireAge);

        document.getElementById('rpt_age').innerText = age;
        document.getElementById('rpt_retireAge').innerText = retireAge;
        document.getElementById('rpt_lifeAge').innerText = lifeAge;
        document.getElementById('rpt_prepYears').innerText = yearsToPrep;
        document.getElementById('rpt_prepYears_s').innerText = yearsToPrep;
        document.getElementById('rpt_retireYears').innerText = yearsInRetire;
        document.getElementById('rpt_inflation').innerText = inflation;
        document.getElementById('rpt_riskRate').innerText = riskRate;

        const monthlyTotal = basicExp + funExp;
        const inflationRate = inflation / 100;
        const inflationFactor = Math.pow(1 + inflationRate, yearsToPrep);
        const futureMonthly = monthlyTotal * inflationFactor;
        const inflatedTotal = (monthlyTotal * 12 * yearsInRetire) * inflationFactor;

        document.getElementById('rpt_basicExp').innerText = fmt(basicExp);
        document.getElementById('rpt_funExp').innerText = fmt(funExp);
        document.getElementById('rpt_monthlyTotal').innerText = fmt(monthlyTotal);
        document.getElementById('rpt_futureMonthly').innerText = fmt(futureMonthly);
        document.getElementById('rpt_inflatedTotal').innerText = fmt(inflatedTotal);

        const realMonthlyPension = liMonthly * (riskRate / 100);
        const totalPension = realMonthlyPension * 12 * yearsInRetire;
        const totalSupply = totalPension + assets;

        document.getElementById('rpt_assets').innerText = fmt(assets);
        document.getElementById('rpt_realPensionMonthly').innerText = fmt(realMonthlyPension);
        document.getElementById('rpt_pensionTotal').innerText = fmt(totalSupply);

        const gap = inflatedTotal - totalSupply;
        const gapEl = document.getElementById('rpt_gapAmount');
        const gapMsg = document.getElementById('rpt_gapMsg');
        const delaySection = document.getElementById('rpt_delay_section');

        if (yearsInRetire > 0 && monthlyTotal > 0) {
            if (gap > 0) {
                gapEl.innerText = "- " + fmt(gap);
                gapEl.style.color = "#dc3545";
                gapMsg.innerText = "尚有資金缺口，建議儘早執行儲蓄計畫";
                gapMsg.style.color = "#dc3545";
                let baseYearlySave = 0;
                if(yearsToPrep > 0) baseYearlySave = gap / yearsToPrep;
                else baseYearlySave = gap;
                document.getElementById('rpt_yearlySave').innerText = fmt(baseYearlySave);
                
                if(yearsToPrep > 3) {
                    delaySection.style.display = 'flex';
                    for(let i=1; i<=3; i++) {
                        const remain = yearsToPrep - i;
                        const newSave = gap / remain;
                        const inc = newSave - baseYearlySave;
                        const pct = (inc / baseYearlySave) * 100;
                        document.getElementById(`d_amt_${i}`).innerText = fmt(newSave);
                        document.getElementById(`d_inc_${i}`).innerText = "+" + fmt(inc);
                        document.getElementById(`d_pct_${i}`).innerText = "+" + pct.toFixed(1) + "%";
                    }
                } else {
                    delaySection.style.display = 'none';
                }
            } else {
                gapEl.innerText = "+ " + fmt(Math.abs(gap));
                gapEl.style.color = "#198754";
                gapMsg.innerText = "恭喜！資產配置已足以應付退休需求";
                gapMsg.style.color = "#198754";
                delaySection.style.display = 'none';
            }
        } else {
            gapEl.innerText = "--";
            gapMsg.innerText = "請輸入完整資料";
            gapEl.style.color = "#333";
            gapMsg.style.color = "#666";
            delaySection.style.display = 'none';
        }
    }

    document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', calculate);
        el.addEventListener('change', calculate);
    });
    calculate();
</script>
</body>
</html>
